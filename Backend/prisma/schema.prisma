generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
  engineType      = "library"
}

datasource db {
  provider = "postgresql"
}

/// *
/// * Role Model - Fixed, immutable role system with deterministic IDs
/// * 
/// * Role IDs are hardcoded and never change:
/// * - ID 1: System Admin (backend-only, never exposed to users)
/// * - ID 2: Pharmacy Admin (user-selectable during registration)
/// * - ID 3: Patient (user-selectable during registration)
/// * 
/// * Design Rationale:
/// * Using fixed integer IDs ensures:
/// * 1. Fast lookups (no name-based resolution)
/// * 2. Deterministic role assignment (ID always maps to same role)
/// * 3. No runtime role discovery needed
/// * 4. Simple frontend → backend → database flow
/// * 5. Security: System Admin not exposed in registration UI
/// * 
/// * Seeding Strategy:
/// * - Roles are seeded once during initial database setup
/// * - Never created dynamically at runtime
/// * - Migration ensures IDs are always 1, 2, 3 respectively
model Role {
  id          Int      @id
  name        RoleType @unique
  displayName String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]

  @@index([name])
}

/// *
/// * User Model - Core user entity for PharmEasy
/// * 
/// * Role Assignment Flow:
/// * 1. Frontend: User selects role (Patient=3 or Pharmacy Admin=2) during registration
/// * 2. Frontend: Sends role ID directly to backend (no role lookup)
/// * 3. Backend: Validates roleId is 2 or 3 (rejects 1 for security)
/// * 4. Backend: Creates user with roleId directly (no role name resolution)
/// * 5. Database: User.roleId foreign key links to Role.id
/// * 
/// * Why Direct ID Assignment:
/// * - No role lookup query needed at registration time
/// * - Role assignment is instant and deterministic
/// * - Reduces database operations
/// * - Eliminates "role not found" runtime errors
/// * 
/// * All users must verify email via OTP before login
/// * 
/// * User Status Flow:
/// * - PATIENT (roleId=3): Status defaults to APPROVED
/// * - PHARMACY (roleId=2): Status defaults to PENDING until admin approves
/// * - ADMIN (roleId=1): Status defaults to APPROVED
model User {
  id             String               @id @default(cuid())
  email          String               @unique
  name           String
  password       String
  phone          String?
  roleId         Int
  status         UserStatus           @default(APPROVED)
  isVerified     Boolean              @default(false)
  verifiedAt     DateTime?
  isActive       Boolean              @default(true)
  lastLogin      DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  otpTokens      OTPToken[]
  passwordResets PasswordResetToken[]
  pharmacy       Pharmacy?
  refreshTokens  RefreshToken[]
  role           Role                 @relation(fields: [roleId], references: [id])
  orders         Order[]              @relation("PatientOrders")
  prescriptions  Prescription[]       @relation("PatientPrescriptions")
  medications    Medication[]         @relation("PatientMedications")
  sosRequests    SOSRequest[]         @relation("PatientSOSRequests")

  @@index([email])
  @@index([roleId])
  @@index([isVerified])
  @@index([status])
}

/// *
/// * RefreshToken Model - Manages JWT refresh tokens
/// * Enables token rotation and security tracking
/// * Tokens are invalidated on logout
model RefreshToken {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  isRevoked Boolean   @default(false)
  revokedAt DateTime?
  userAgent String?
  ipAddress String?
  expiresAt DateTime
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRevoked])
}

/// *
/// * OTPToken Model - Email verification and OTP management
/// * OTP is 6-digit numeric code sent via email
/// * Each OTP is single-use and expires after 10 minutes
model OTPToken {
  id        String    @id @default(cuid())
  userId    String
  code      String
  isUsed    Boolean   @default(false)
  usedAt    DateTime?
  expiresAt DateTime
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isUsed])
}

/// *
/// * PasswordResetToken Model - Secure password reset flow
/// * Token is single-use and expires after 1 hour
/// * Prevents brute-force password reset attacks
model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  isUsed    Boolean   @default(false)
  usedAt    DateTime?
  expiresAt DateTime
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isUsed])
}

/// *
/// * Pharmacy Model - Pharmacy information and verification
/// * 
/// * Two-Step Pharmacy Registration:
/// * 1. User registers with roleId=2 (PHARMACY_ADMIN)
/// * 2. After authentication, user submits pharmacy onboarding
/// * 3. SystemAdmin verifies or rejects the pharmacy
/// * 4. Only VERIFIED pharmacies can access inventory & SOS features
/// * 
/// * Verification Status Flow:
/// * PENDING_VERIFICATION → VERIFIED (approved by admin)
/// * PENDING_VERIFICATION → REJECTED (rejected by admin)
/// * REJECTED → cannot re-register without admin action
model Pharmacy {
  id                 String         @id @default(cuid())
  userId             String         @unique
  pharmacyName       String
  address            String
  latitude           Float
  longitude          Float
  licenseNumber      String         @unique
  licenseDocument    String?
  contactNumber      String
  verificationStatus PharmacyStatus @default(PENDING_VERIFICATION)
  verifiedAt         DateTime?
  verifiedBy         String?
  rejectionReason    String?
  rejectedAt         DateTime?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  user               User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  inventory          Inventory[]

  @@index([userId])
  @@index([verificationStatus])
  @@index([licenseNumber])
}

/// *
/// * Inventory Model - Medicine/Drug inventory management
/// * 
/// * Represents individual medicine items in a pharmacy's stock
/// * Each pharmacy maintains its own inventory of medicines
/// * 
/// * Fields:
/// * - name: Brand/product name (e.g., "Cetamol 500mg")
/// * - genericName: Generic drug name (e.g., "Paracetamol")
/// * - quantity: Real-time stock count
/// * - price: Unit price per medicine
/// * - expiryDate: Expiration date for batch tracking
/// * - pharmacyId: Links medicine to specific pharmacy
model Inventory {
  id          String   @id @default(uuid())
  name        String
  genericName String
  quantity    Int
  price       Float
  expiryDate  DateTime
  pharmacyId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  pharmacy    Pharmacy @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)

  @@index([pharmacyId])
  @@index([genericName])
  @@index([expiryDate])
}

enum RoleType {
  PATIENT
  PHARMACY_ADMIN
  SYSTEM_ADMIN
}

enum UserStatus {
  ONBOARDING_REQUIRED
  PENDING
  APPROVED
  REJECTED
}

enum PharmacyStatus {
  PENDING_VERIFICATION
  VERIFIED
  REJECTED
}

/// *
/// * Order Model - Patient medication orders
/// * 
/// * Represents an order from a patient to a pharmacy
/// * Status flow: PENDING → CONFIRMED → DELIVERED or CANCELLED
model Order {
  id          String    @id @default(cuid())
  patientId   String
  pharmacyId  String?
  status      String    @default("pending")
  totalAmount Float?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  patient     User      @relation("PatientOrders", fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([status])
  @@index([createdAt])
}

/// *
/// * Prescription Model - Patient prescriptions
/// * 
/// * Stores prescription documents and history
model Prescription {
  id          String    @id @default(cuid())
  patientId   String
  documentUrl String?
  issuedDate  DateTime?
  expiryDate  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  patient     User      @relation("PatientPrescriptions", fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([issuedDate])
}

/// *
/// * Medication Model - Patient medication history
/// * 
/// * Tracks medications a patient is taking or has taken
model Medication {
  id          String    @id @default(cuid())
  patientId   String
  medicineName String
  genericName String?
  dosage      String?
  frequency   String?
  isActive    Boolean   @default(true)
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  patient     User      @relation("PatientMedications", fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([isActive])
}

/// *
/// * SOSRequest Model - Emergency SOS medication requests
/// * 
/// * Urgent medicine requests that need quick fulfillment
/// * Status: pending → fulfilled → expired
model SOSRequest {
  id                   String    @id @default(cuid())
  patientId            String
  medicineName         String
  genericName          String?
  quantity             Int       @default(1)
  urgencyLevel         String    @default("high")
  patientName          String
  contactNumber        String
  address              String
  latitude             Float?
  longitude            Float?
  additionalNotes      String?
  prescriptionRequired Boolean   @default(false)
  status               String    @default("pending")
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  patient              User      @relation("PatientSOSRequests", fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([status])
  @@index([urgencyLevel])
  @@index([createdAt])
}

/// *
/// * Log Model - System-wide activity logging and audit trail
/// * 
/// * Captures all critical system events for transparency and debugging
/// * Categories: AUTH (login/logout), PHARMACY (approvals/rejections), SYSTEM (errors/alerts)
/// * 
/// * Usage:
/// * - Admin approves pharmacy: category=PHARMACY, action=PHARMACY_APPROVED
/// * - User logs in: category=AUTH, action=USER_LOGIN
/// * - Profile updated: category=SYSTEM, action=PROFILE_UPDATED
/// * 
/// * Provides complete audit trail for compliance and security monitoring
model Log {
  id        String      @id @default(cuid())
  action    String
  message   String
  userId    String?
  category  LogCategory
  metadata  Json?
  createdAt DateTime    @default(now())

  @@index([category])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
}

enum LogCategory {
  AUTH
  PHARMACY
  SYSTEM
  USER
  INVENTORY
  ORDER
}
